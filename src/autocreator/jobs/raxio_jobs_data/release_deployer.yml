<%include file="trigger_defaults.yml"/>
<%include file="default.yml"/>

job_description: Deploys release artifact to cloud files
numOfJobsToKeep: 10
daysToKeep: 7
buildParams:
  - paramName: RELEASE_TAG
    paramValue: "Release tag"
    paramDesc:  "Release tag"
    paramType: string
  - paramName: RELEASE_DESCRIPTION
    paramValue: "Release description"
    paramDesc:  "Release description"
    paramType: string
scm:
  gitURL: "ssh://git@github.com/dimtruck/OpenStackProject.git"
  gitBranch: "*/master"
  extensions: 
    cleanbeforecheckout: True
shell_build_command: 
  - build: |
           <%text>#!/bin/bash
           . ~/.profile
           rm -rf arbor-${RELEASE_TAG}
           virtualenv arbor-${RELEASE_TAG}
           rm -rf arbor-${RELEASE_TAG}/source
           mkdir -p arbor-${RELEASE_TAG}/source
           cp -R contrib coverage.sh doc Dockerfile etc examples functionaltests HACKING.rst LICENSE MANIFEST.in openstack-common.conf README.rst requirements.txt setup.cfg setup.py solum test-requirements.txt tools tox.ini -t arbor-${RELEASE_TAG}/source/
           git clone git@github.com:rackerlabs/arbor_labs-cookbook-arbor_lab.git arbor-${RELEASE_TAG}/chef
           cd arbor-${RELEASE_TAG}/chef
           git checkout arborlabs_on_solum
           berks vendor .chef/cookbooks
           cd ../..
           . arbor-${RELEASE_TAG}/bin/activate
           pip install -r test-requirements.txt
           pip install -r requirements.txt
           pip install .
           pip uninstall librabbitmq
           virtualenv --relocatable arbor-${RELEASE_TAG}
           tar czvf arbor-${RELEASE_TAG}.tar.gz arbor-${RELEASE_TAG}/
           deactivate

           if ${IS_PRE_RELEASE} ; then
             ~/bin/linux/amd64/github-release release -u rackerlabs -r arbor -t v${RELEASE_TAG} -n &quot;${RELEASE_TAG}&quot; -d &quot;${RELEASE_DESCRIPTION}&quot; -p
           else
             ~/bin/linux/amd64/github-release release -u rackerlabs -r arbor -t v${RELEASE_TAG} -n &quot;${RELEASE_TAG}&quot; -d &quot;${RELEASE_DESCRIPTION}&quot;
           fi

           ~/bin/linux/amd64/github-release upload -u rackerlabs -r arbor -t v${RELEASE_TAG} -n &quot;arbor-${RELEASE_TAG}&quot; --file arbor-${RELEASE_TAG}.tar.gz
           cd ~/
           ansible-playbook ~/push-to-files-release.yml --extra-vars &quot;name=/var/lib/jenkins/jobs/arbor_release_deployer/workspace/arbor-${RELEASE_TAG}.tar.gz&quot; -vvvv</%text>
rubyProxyObject:
  pipList: "tox&lt;1.7"
buildTrigger:
  projects: "raxio_jobs_data_blue_node_deployer"
  triggerCondition: SUCCESS
